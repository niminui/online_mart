<!doctype html>
<html class="no-js" lang="zh" xmlns:th="http://www.thymeleaf.org">
 
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>大润发 - 我的账户</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicons -->
    <link rel="shortcut icon" href="assets/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="assets/img/icon.png">

    <!-- ************************* CSS Files ************************* -->

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="assets/css/vendor.css">

    <!-- style css -->
    <link rel="stylesheet" href="assets/css/main.css">

</head>

<body>

    <!-- Preloader Start -->
    <div class="zakas-preloader active">
        <div class="zakas-preloader-inner h-100 d-flex align-items-center justify-content-center">
            <div class="zakas-child zakas-bounce1"></div>
            <div class="zakas-child zakas-bounce2"></div>
            <div class="zakas-child zuka-bounce3"></div>
        </div>
    </div>
    <!-- Preloader End -->

    <!-- Main Wrapper Start -->
    <div class="wrapper">
        <!-- 导航栏 -->
        <header class="header">
            <div class="header-inner fixed-header">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-xl-10 col-lg-9 col-3">
                            <nav class="main-navigation">
                                <div class="site-branding">
                                    <a href="/" class="logo">
                                        <figure class="logo--normal">
                                            <img src="assets/img/logo/logo.png" alt="Logo">
                                        </figure>
                                    </a>
                                </div>
                                <div class="mainmenu-nav d-none d-lg-block" th:if="${session.administrator == null}">
                                    <ul class="mainmenu">
                                        <li class="mainmenu__item menu-item-has-children active">
                                            <a href="/" class="mainmenu__link">
                                                <span class="mm-text">主页</span>
                                            </a>
                                        </li>
                                        <li class="mainmenu__item menu-item-has-children">
                                            <a href="/shopController" class="mainmenu__link">
                                                <span class="mm-text">商店</span>
                                            </a>
                                        </li>
                                        <li class="mainmenu__item menu-item-has-children">
                                            <a href="Blog.html" class="mainmenu__link">
                                                <span class="mm-text">通知</span>
                                            </a>
                                        </li>
                                        <li class="mainmenu__item">
                                            <a href="contact-us.html" class="mainmenu__link">
                                                <span class="mm-text">联系我们</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>

                                <div class="mainmenu-nav d-none d-lg-block" th:if="${session.administrator != null}">
                                    <ul class="mainmenu">
                                        <li class="mainmenu__item menu-item-has-children active">
                                            <a href="/" class="mainmenu__link">
                                                <span class="mm-text">主页</span>
                                            </a>
                                        </li>
                                        <li class="mainmenu__item menu-item-has-children">
                                            <a href="/shopController" class="mainmenu__link">
                                                <span class="mm-text">查看商店</span>
                                            </a>
                                        </li>
                                        <li class="mainmenu__item menu-item-has-children">
                                            <a href="Blog.html" class="mainmenu__link">
                                                <span class="mm-text">创建通知</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>
                        </div>
                        <div class="col-xl-2 col-lg-3 col-9 text-right">
                            <!--用户登录时导航信息-->
                            <ul class="header-toolbar" th:if="${session.user != null && session.administrator == null}">
                                <li class="header-toolbar__item">
                                    <a href="wishlist.html" class="header-toolbar__btn">
                                        <i class="flaticon flaticon-like"></i>
                                    </a>
                                </li>
                                <!--购物车模态框-->
                                <li class="header-toolbar__item mini-cart-item">
                                    <a id="cartHref" href="#miniCart" class="header-toolbar__btn toolbar-btn mini-cart-btn">
                                        <i class="flaticon flaticon-shopping-cart"></i>
                                    </a>
                                </li>

                                <li class="header-toolbar__item user-info">
                                    <a href="/myAccount" class="header-toolbar__btn">
                                        <i class="flaticon flaticon-user"></i>
                                    </a>
                                    <ul class="active user-info-menu">
                                        <li>
                                            <a href="/myAccount">我的账户</a>
                                        </li>
                                        <li>
                                            <a href="cart.html">购物车</a>
                                        </li>

                                        <li>
                                            <a href="wishlist.html">心愿列表</a>
                                        </li>
                                        <li>
                                            <a href="/logout">登出</a>
                                        </li>
                                    </ul>
                                </li>

                                <li class="header-toolbar__item">
                                    <a href="#searchForm" class="header-toolbar__btn toolbar-btn">
                                        <i class="flaticon flaticon-search"></i>
                                    </a>
                                </li>
                                <li class="header-toolbar__item d-lg-none">
                                    <a href="#" class="header-toolbar__btn menu-btn">
                                        <i class="fa fa-bars"></i>
                                    </a>
                                </li>
                            </ul>

                            <!--用户未登录时导航信息-->
                            <ul class="header-toolbar" th:if="${session.user == null && session.administrator == null} ">
                                <li class="header-toolbar__item user-info">
                                    <a href="/loginOrRegister" class="header-toolbar__btn">
                                        <i class="flaticon flaticon-user"></i>
                                    </a>
                                    <ul class="active user-info-menu">
                                        <li>
                                            <a href="/loginOrRegister">登录 & 注册</a>
                                        </li>
                                        <li>
                                            <a href="/managerLoginTemp">管理员登录</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="header-toolbar__item">
                                    <a href="#searchForm" class="header-toolbar__btn toolbar-btn">
                                        <i class="flaticon flaticon-search"></i>
                                    </a>
                                </li>
                                <li class="header-toolbar__item d-lg-none">
                                    <a href="#" class="header-toolbar__btn menu-btn">
                                        <i class="fa fa-bars"></i>
                                    </a>
                                </li>
                            </ul>

                            <!--管理员登录时-->
                            <!--用户登录时导航信息-->
                            <ul class="header-toolbar" th:if="${session.user == null && session.administrator != null}">
                                <li class="header-toolbar__item user-info">
                                    <a href="/managerPage" class="header-toolbar__btn">
                                        <i class="flaticon flaticon-user"></i>
                                    </a>
                                    <ul class="active user-info-menu">
                                        <li>
                                            <a href="/showProductionList">商品列表</a>
                                        </li>
                                        <li>
                                            <a href="/managerPage">添加新的商品</a>
                                        </li>
                                        <li>
                                            <a href="/logout">登出</a>
                                        </li>
                                    </ul>
                                </li>

                                <li class="header-toolbar__item">
                                    <a href="#searchForm" class="header-toolbar__btn toolbar-btn">
                                        <i class="flaticon flaticon-search"></i>
                                    </a>
                                </li>
                                <li class="header-toolbar__item d-lg-none">
                                    <a href="#" class="header-toolbar__btn menu-btn">
                                        <i class="fa fa-bars"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mobile-menu"></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- 查询页面 -->
        <div class="searchform__popup" id="searchForm">
            <a href="#" class="btn-close"><i class="flaticon flaticon-cross"></i></a>
            <div class="searchform__body">
                <p>开始输入内容，然后按Enter键进行搜索</p>
                <form class="searchform">
                    <input type="text" name="popup-search" id="popup-search" class="searchform__input" placeholder="搜索整个商店...">
                    <button type="submit" class="searchform__submit"><i class="flaticon flaticon-magnifying-glass-icon"></i></button>
                </form>
            </div>
        </div>

        <!-- Breadcrumb area Start -->
        <div class="breadcrumb-area bg-color ptb--90" data-bg-color="#f6f6f6">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center flex-sm-row flex-column">
                            <h1 class="page-title">我的账户</h1>
                            <ul class="breadcrumb">
                                <li><a href="index.html">主页</a></li>
                                <li class="current"><span>我的账户</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Breadcrumb area End -->

        <!-- Main Content Wrapper Start -->
        <div class="main-content-wrapper">
            <div class="page-content-inner ptb--80">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <div class="user-dashboard-tab flex-column flex-md-row">
                                <div class="user-dashboard-tab__head nav flex-md-column" role="tablist" aria-orientation="vertical">
                                    <a class="nav-link active" data-toggle="pill" role="tab" href="#dashboard" aria-controls="dashboard" aria-selected="true">预览</a>
                                    <a id="hrefOrders" class="nav-link" data-toggle="pill" role="tab" href="#orders" aria-controls="orders" aria-selected="true">订单</a>
                                    <a class="nav-link" data-toggle="pill" role="tab" href="#addresses" aria-controls="addresses" aria-selected="true">我的地址</a>
                                    <a class="nav-link" data-toggle="pill" role="tab" href="#accountdetails" aria-controls="accountdetails" aria-selected="true">我的信息</a>
                                    <a class="nav-link" href="/logout">登出</a>
                                </div>
                                <div class="user-dashboard-tab__content tab-content">
                                    <div class="tab-pane fade show active" id="dashboard">
                                        <p>你好 <strong th:text="${user.name}"></strong></p>
                                        <p>从预览页面您可以轻松查看您账户的信息(账户信息不对？请点击“我的信息”进行更改)</p>
                                    </div>

                                    <!--订单模块-->
                                    <div class="tab-pane fade" id="orders">
                                        <div class="message-box mb--30 d-none">
                                            <p><i class="fa fa-check-circle"></i>您还没有任何订单！</p>
                                            <a href="/showProductionList">去商品列表</a>
                                        </div>
                                        <div class="table-content table-responsive">
                                            <table class="table text-center">
                                                <thead>
                                                    <tr>
                                                        <th>订单编号</th>
                                                        <th>交易日期</th>
                                                        <th>状态</th>
                                                        <th>总金额</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="order_tbody">

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>


                                    <div class="tab-pane fade" id="addresses">
                                        <p class="mb--20">默认情况下，以下地址将在结帐页面上使用。</p>
                                        <div class="row">
                                            <div class="col-md-6 mb-sm--20">
                                                <div class="text-block">
                                                    <h4 class="mb--20">帐单地址：</h4>
                                                    <p th:if="${user.address == null || user.address == ''}">您尚未设置此类型的地址。</p>
                                                    <p th:if="${user.address != null && user.address != ''}" th:text="${user.address}"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="accountdetails">
                                        <form action="/updateNyAccount" class="form form--account">
                                            <!--姓名-->
                                            <div class="row mb--20">
                                                <div class="col-12">
                                                    <div class="form__group">
                                                        <label class="form__label form__label--2" for="d_name">昵称 <span class="required">*</span></label>
                                                        <input type="text" th:value="${#session.getAttribute('user').name}" name="name" id="d_name" class="form__input" autocomplete="off">
                                                        <span class="helpBlock"></span>
                                                        <span class="suggestion"><em>这将是您的姓名在帐户部分和评论中显示的方式</em></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!--email-->
                                            <div class="row mb--20">
                                                <div class="col-12">
                                                    <div class="form__group">
                                                        <label class="form__label form__label--2" for="email">Email <span class="required">*</span></label>
                                                        <input type="email" th:value="${#session.getAttribute('user').email}" name="email" id="email" class="form__input" autocomplete="off">
                                                        <span class="helpBlock"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!--电话-->
                                            <div class="row mb--20">
                                                <div class="col-12">
                                                    <div class="form__group">
                                                        <label class="form__label form__label--2" for="telephone">电话 <span class="required">*</span></label>
                                                        <input type="text" th:value="${#session.getAttribute('user').telephone}" name="telephone" id="telephone" class="form__input" autocomplete="off">
                                                        <span class="helpBlock"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!--地址-->
                                            <div class="row mb--20">
                                                <div class="col-12">
                                                    <div class="form__group">
                                                        <label class="form__label form__label--2" for="address">地址 <span class="required">*</span></label>
                                                        <input type="text" th:value="${#session.getAttribute('user').address}" name="address" id="address" class="form__input" autocomplete="off">
                                                    </div>
                                                </div>
                                            </div>

                                            <!--生日-->
                                            <div class="row mb--20">
                                                <div class="col-12">
                                                    <div class="form__group">
                                                        <label class="form__label form__label--2" for="birthday">生日 <span class="required">*</span></label>
                                                        <input type="date" name="birthday" id="birthday" class="form__input">
                                                    </div>
                                                </div>
                                            </div>


                                            <fieldset class="form__fieldset mb--20">
                                                <legend class="form__legend">更改密码</legend>
                                                <div class="row mb--20">
                                                    <div class="col-12">
                                                        <div class="form__group">
                                                            <label class="form__label form__label--2" for="cur_password">当前密码（保留空白以保持不变）</label>
                                                            <input type="password" name="cur_pass" id="cur_password" class="form__input">
                                                            <span class="helpBlock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row mb--20">
                                                    <div class="col-12">
                                                        <div class="form__group">
                                                            <label class="form__label form__label--2" for="new_password">新密码（保留空白以保持不变）</label>
                                                            <input type="password" id="new_password" class="form__input">
                                                            <span class="helpBlock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <div class="form__group">
                                                            <label class="form__label form__label--2" for="conf_new_pass">确认您的新密码（保留空白以保持不变）</label>
                                                            <input type="password" name="password" id="conf_new_pass" class="form__input">
                                                            <span class="helpBlock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="form__group">
                                                        <input id="save_user" type="submit" value="保存更改" class="btn btn-style-1 btn-submit">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Main Content Wrapper Start -->

        <div th:replace="footer :: footer"></div>

        <!-- Mini Cart Start -->
        <aside class="mini-cart" id="miniCart">
            <div class="mini-cart-wrapper">
                <a href="" class="btn-close"><i class="flaticon flaticon-cross"></i></a>
                <div class="mini-cart-inner">
                    <h3 class="mini-cart__heading mb--40 mb-lg--30">购物车</h3>
                    <div class="mini-cart__content" >
                        <ul id="cart_ul" class="mini-cart__list">

                        </ul>

                        <div class="mini-cart__total">
                            <span>总计</span>
                            <span id="count_span" class="ammount"></span>
                        </div>
                        <div class="mini-cart__buttons">
                            <a href="cart.html" class="btn btn-fullwidth btn-bg-sand mb--20">查看购物车</a>
                            <a href="checkout.html" class="btn btn-fullwidth btn-bg-sand">查看</a>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <!-- Mini Cart End -->

        <!-- Global Overlay Start -->
        <div class="zakas-global-overlay"></div>
        <!-- Global Overlay End -->
    </div>
    <!-- Main Wrapper End -->
 

    <!-- ************************* JS Files ************************* -->

    <!-- jQuery JS -->
    <script type="text/javascript" src="assets/js/vendor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

    <!-- Main JS -->
    <script src="assets/js/main.js"></script>

    <script type="text/javascript" th:inline="javascript">
        //获取项目根目录
        var ctxPath=[[${#httpServletRequest.getContextPath()}]];

        //注册时验证
        function validate_update_form() {
            //验证邮箱信息
            var email = $("#email").val();
            var regEmail = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/;
            if(email == null || email === "") {
                show_validate_msg("#email","error","邮箱不能为空！");
                return false;
            } else if(!regEmail.test(email)) {
                show_validate_msg("#email","error","邮箱格式不正确");
                return false;
            } else {
                show_validate_msg("#email","success","");
            }

            //验证密码
            var password = $("#new_password").val();
            var confirm_password = $("#conf_new_pass").val();
            var regPassword = /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,16}$/;
            if((password == null || password === "") && (confirm_password == null || confirm_password === "") ) {
                return true;
            }else if(!regPassword.test(password)) {
                show_validate_msg("#new_password","error","密码必须包含字母和数字，且长度在8~16位之间！");
                return false;
            } else {
                if(password !== confirm_password) {
                    show_validate_msg("#new_password","success","");
                    show_validate_msg("#conf_new_pass","error","两次密码输入不一致！");
                    return false;
                }
                show_validate_msg("#new_password","success","");
            }

            //验证电话号码
            var phoneNumber = $("#telephone").val();
            var regxPhoneNumber = /^1[3-9]\d{9}$/;
            if(phoneNumber == null || phoneNumber === "") {
                show_validate_msg("#telephone","error","手机号码不能为空！");
                return false;
            } else if(!regxPhoneNumber.test(phoneNumber)) {
                show_validate_msg("#telephone","error","请输入正确的手机号码！");
                return false;
            } else {
                show_validate_msg("#telephone","success","");
            }
            return true;
        }

        //显示校验结果的提示
        function show_validate_msg(ele,status,msg) {
            //清楚当前元素校验状态
            $(ele).parent().removeClass("has-success has-error");
            $(ele).next("span").text("");
            if(status == "success") {
                $(ele).parent().addClass("has-success");
                $(ele).next("span").text(msg);
            } else if (status == "error"){
                $(ele).parent().addClass("has-error");
                $(ele).next("span").text(msg);
            }
        }

        //点击注册时进行验证
        $("#save_user").click(function () {
            //进行邮箱和密码的校验
            if(!validate_update_form()) {
                return false;
            }
        });

        //验证注册邮箱是否可用
        $("#email").change(function () {
            var update_email = this.value;
            $.ajax({
                url:ctxPath + "/checkEmail",
                data:"email=" + update_email,
                type:"POST",
                success:function (result) {
                    if(result.code === 100) {
                        show_validate_msg("#email","success","");
                    } else {
                        show_validate_msg("#email","error",result.extend.va_msg);
                    }
                }
            });
        });

        //查询原密码是否正确
        $("#cur_password").change(function () {
            var password = this.value;
            $.ajax({
               url:ctxPath + "/checkPw",
               data:"password=" + password,
               type:"POST",
               success : function (result) {
                   if(result.code === 100) {
                       show_validate_msg("#cur_pass","success","");
                   } else {
                       alert(result.extend.pw);
                   }
               }
            });
        });

        //购物车模态框
        $("#cartHref").click(function () {
            var json = JSON.stringify(JSON.parse(decodeURIComponent(Cookies.get("cart"))));
            $.ajax({
                url: ctxPath + "/cartTransferStation",
                data: json,
                type: "POST",
                success: function (result) {
                    var cartItems = [];
                    for(var item in result) {
                        cartItems.push(result[item]);
                    }
                    add_Element_to_model(cartItems);
                }
            });
        });

        //订单模态框
        $("#hrefOrders").click(function () {
           $.ajax({
              url: ctxPath + "/getOrderList",
              type: "POST",
              success : function (result) {
                  if(result.code === 100) {
                      var orderArray = [];
                      var orderList = result.extend.orderForms;
                      for(var item in orderList) {
                          orderArray.push(orderList[item]);
                      }
                      add_Element_to_order_model(orderArray);
                  } else {
                      alert(result.extend.msg);
                  }
              }
           });
        });

        //向 购物车 模态框中添加信息
        function add_Element_to_model(cartItems) {
            reset_cart();
            var production_Sum = 0;
            for(var i = 0; i < cartItems.length; i++) {
                var liTd = $("<li></li>").addClass("mini-cart__product");
                var deleteTd = $("<a id='deleteProByCart'></a>").addClass("remove-from-cart remove").attr("href","/deleteProductionByCart/"+cartItems[i].id+"?page=myAccount");
                var iTd = $("<i></i>").addClass("flaticon flaticon-cross");
                var divTd = $("<div></div>").addClass("mini-cart__product__content");
                var nameTd = $("<a href='product-details.html'></a>").addClass("mini-cart__product__title").append(cartItems[i].name);
                var countAndPrice = $("<span></span>").addClass("mini-cart__product__quantity").append(cartItems[i].count + ' × ' + cartItems[i].price + ' 元');
                liTd.append(deleteTd.append(iTd)).append(divTd.append(nameTd).append(countAndPrice)).appendTo("#cart_ul");
                production_Sum += cartItems[i].price * cartItems[i].count;
            }
            $("#count_span").append(production_Sum.toFixed(2) + ' 元');
        }

        //向 订单 模态框中添加信息
        function add_Element_to_order_model(orderArray) {
            reset_order();
            for(var i = 0; i < orderArray.length; i++) {
                var preTr = $("<tr></tr>");
                var numberTd = $("<td></td>").append(orderArray[i].id);
                var dateTd = $("<td></td>").addClass("wide-column").append(timestampToTime(orderArray[i].gmtCreate));
                var statusTd = $("<td></td>").append(orderArray[i].status);
                var priceTd = $("<td></td>").addClass("wide-column").append(orderArray[i].totalPrice + " 元");
                var hrefTd = $("<td></td>");
                var hrefA = $("<a></a>").attr("href","/getOrderInfo/"+orderArray[i].id).addClass("btn btn-small btn-bg-red btn-color-white btn-hover-2").append("查看");
                preTr.append(numberTd).append(dateTd).append(statusTd).append(priceTd).append(hrefTd.append(hrefA)).appendTo("#order_tbody");
            }
        }

        //清除 购物车 模态框中的信息
        function reset_cart() {
            var ul = document.getElementById("cart_ul");
            while(ul.hasChildNodes()) {
                ul.removeChild(ul.firstChild);
            }
            $("#count_span").text("");
        }

        //清除 订单 模态框中的信息
        function reset_order() {
            var tbody = document.getElementById("order_tbody");
            while(tbody.hasChildNodes()) {
                tbody.removeChild(tbody.firstChild);
            }
        }

        //时间戳转日期
        function timestampToTime(timestamp) {
            var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
            var Y = date.getFullYear() + '-';
            var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            var D = date.getDate() + ' ';
            var h = date.getHours() + ':';
            var m = date.getMinutes() + ':';
            var s = date.getSeconds();
            return Y+M+D+h+m+s;
        }

    </script>

</body>

</html>